#!/usr/bin/env python3
import requests
import json
import sys
import argparse

BASE_URL = "http://localhost:19880/api/v1/mcp"

def list_tools():
    try:
        res = requests.get(f"{BASE_URL}/tools")
        res.raise_for_status()
        tools = res.json().get("tools", [])
        print(f"{ 'SERVER':<15} {'TOOL NAME':<20} {'DESCRIPTION'}")
        print("-" * 60)
        for t in tools:
            server = t.get('_server_name', 'unknown')
            name = t.get('name')
            desc = t.get('description', '')[:40]
            print(f"{server:<15} {name:<20} {desc}")
    except Exception as e:
        print(f"Error: {e}")

def call_tool(tool_name, args_json):
    # 既然此时我们不知道 server_name，我们需要先查询
    # 或者让后端支持自动路由（如果工具名唯一）
    # 目前后端 POST /call 需要 server_name。
    # 我们可以先 list 一遍找到 server_name。
    
    try:
        # 1. Find server
        res = requests.get(f"{BASE_URL}/tools")
        tools = res.json().get("tools", [])
        target_tool = next((t for t in tools if t['name'] == tool_name), None)
        
        if not target_tool:
            print(f"Error: Tool '{tool_name}' not found.")
            return

        server_name = target_tool.get('_server_name')
        
        # 2. Call
        payload = {
            "server_name": server_name,
            "arguments": json.loads(args_json) if args_json else {}
        }
        
        print(f"Calling {tool_name} on {server_name}...")
        call_res = requests.post(f"{BASE_URL}/tools/{tool_name}/call", json=payload)
        call_res.raise_for_status()
        
        result = call_res.json()
        print(json.dumps(result, indent=2, ensure_ascii=False))

    except json.JSONDecodeError:
        print("Error: Arguments must be valid JSON string.")
    except Exception as e:
        print(f"Error: {e}")

def main():
    parser = argparse.ArgumentParser(description="PromptStudio MCP CLI Client")
    subparsers = parser.add_subparsers(dest="command")

    # List command
    subparsers.add_parser("list", help="List all available tools")

    # Call command
    call_parser = subparsers.add_parser("call", help="Call a tool")
    call_parser.add_argument("tool", help="Name of the tool")
    call_parser.add_argument("args", nargs="?", default="{}", help="JSON arguments (e.g. '{\"a\": 1}')")

    args = parser.parse_args()

    if args.command == "list":
        list_tools()
    elif args.command == "call":
        call_tool(args.tool, args.args)
    else:
        parser.print_help()

if __name__ == "__main__":
    main()
